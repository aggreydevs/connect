# Production Setup (Tuwunel + Caddy on Hetzner VPS)

This document covers the full production deployment of Tuwunel on a shared VPS from Hetzner, using Caddy as a reverse proxy with automatic HTTPS.

---

## Architecture Overview

```mermaid
flowchart TD
    U[User / Matrix Client] -->|HTTPS| V[Vercel - Landing]
    U -->|HTTPS| C[Caddy - matrix.soundadvice.club]
    V -->|.well-known/matrix/*| U
    C -->|reverse_proxy| T[Tuwunel :8008]
    T -->|OAuth 2.1| S[Supabase Cloud]

    subgraph Vercel
        V
        WK[".well-known/matrix/server\n.well-known/matrix/client"]
    end

    subgraph Hetzner VPS
        C
        T
    end
```

| Component       | Platform       | Notes                                                   |
| --------------- | -------------- | ------------------------------------------------------- |
| **Tuwunel**     | Hetzner VPS    | Native `.deb` install, managed by systemd               |
| **Caddy**       | Hetzner VPS    | Reverse proxy with automatic TLS                        |
| **Supabase**    | Supabase Cloud | OAuth 2.1 / OpenID Connect provider                     |
| **DNS**         | Vercel         | `matrix` A record pointing to the VPS public IP         |
| **.well-known** | Vercel         | Matrix delegation files served from the landing project |

---

## Prerequisites

- A shared VPS on Hetzner (aarch64)
- A domain with DNS managed by Vercel (or any DNS provider)
- A Supabase Cloud project with an OAuth App created

---

## 1. Provision the VPS

Create a shared VPS on Hetzner. During creation, add an SSH key so you can access the server without a password.

Connect via SSH:

```bash
ssh root@<VPS_IP>
```

Update the system:

```bash
apt update && apt upgrade -y
```

---

## 2. Create System User and Directories

Create a dedicated system user for Tuwunel (no login shell, no home directory):

```bash
useradd -r --shell /usr/bin/nologin --no-create-home tuwunel
```

Create the data and configuration directories:

```bash
mkdir -p /var/lib/tuwunel/
chown -R tuwunel:tuwunel /var/lib/tuwunel/
chmod 700 /var/lib/tuwunel/
mkdir -p /etc/tuwunel
```

---

## 3. Install Tuwunel

Download the latest `.deb` release for aarch64 and install it:

```bash
wget https://github.com/matrix-construct/tuwunel/releases/download/v1.5.0/v1.5.0-release-all-aarch64-v8-linux-gnu-tuwunel.deb -O tuwunel.deb
dpkg -i tuwunel.deb
```

Verify the installation:

```bash
tuwunel --version
```

---

## 4. Configure Supabase OAuth

In the Supabase Dashboard, create an OAuth App for your project. This generates a **client ID** and a **client secret**.

> [!IMPORTANT]
> The `client_id` used in the Tuwunel identity provider configuration must be the one generated by Supabase when creating the OAuth App.

Save the client secret to a file:

```bash
echo -n "SECRET_HERE" > /etc/tuwunel/.client_secret
```

Lock down permissions:

```bash
chmod 600 /etc/tuwunel/.client_secret
chown tuwunel:tuwunel /etc/tuwunel/.client_secret
```

---

## 5. Configure Tuwunel

Create the configuration file:

```bash
vi /etc/tuwunel/tuwunel.toml
```

Full configuration:

```toml
[global]
server_name = "soundadvice.club"
database_path = "/var/lib/tuwunel"
address = ["0.0.0.0"]
port = 8008
allow_registration = false
allow_encryption = true
grant_admin_to_first_user = true
new_user_displayname_suffix = ""
max_request_size = 20971520  # 20MB
# Prevents users from creating rooms (admins can always create rooms)
allow_room_creation = false
block_non_admin_invites = true
# No federation
allow_federation = false
allow_public_room_directory_over_federation = false
allow_inbound_profile_lookup_federation_requests = false
auto_join_rooms = [
    "#announcements:soundadvice.club",
    "#events:soundadvice.club",
    "#general:soundadvice.club",
]
access_control_allow_origin = [
    "https://connect.soundadvice.club",
    "https://app.soundadvice.club"
]

[global.well_known]
client = "https://matrix.soundadvice.club"
server = "matrix.soundadvice.club:443"

[[global.identity_provider]]
brand = "SoundAdvice"
client_id = "<SUPABASE_OAUTH_CLIENT_ID>"
client_secret_file = "/etc/tuwunel/.client_secret"
issuer_url = "https://xotpctnbcmgkwmiplesn.supabase.co/auth/v1"
discovery_url = "https://xotpctnbcmgkwmiplesn.supabase.co/auth/v1/.well-known/openid-configuration"
callback_url = "https://matrix.soundadvice.club/_matrix/client/unstable/login/sso/callback/<SUPABASE_OAUTH_CLIENT_ID>"
discovery = true
scope = ["openid", "email", "profile"]
default = true
grant_session_duration = 600
```

Replace `<SUPABASE_OAUTH_CLIENT_ID>` with the client ID generated by Supabase.

---

## 6. Install and Configure Caddy

Install Caddy from the official repository:

```bash
apt install -y debian-keyring debian-archive-keyring apt-transport-https curl

curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
apt update && apt install caddy -y
```

Configure the reverse proxy:

```bash
vi /etc/caddy/Caddyfile
```

```caddyfile
{
    email admin@soundadvice.club
}

matrix.soundadvice.club {
    reverse_proxy /_matrix/* localhost:8008
    reverse_proxy /_tuwunel/* localhost:8008
    reverse_proxy /.well-known/matrix/* localhost:8008
}
```

Validate and format the configuration:

```bash
caddy validate --config /etc/caddy/Caddyfile
caddy fmt --overwrite /etc/caddy/Caddyfile
caddy validate --config /etc/caddy/Caddyfile
```

---

## 7. Enable and Start Services

Enable both services to start on boot and start them now:

```bash
systemctl enable caddy
systemctl start caddy
systemctl enable tuwunel
systemctl start tuwunel
```

Verify both services are running:

```bash
systemctl status caddy --no-pager -l
systemctl status tuwunel --no-pager -l
```

Confirm they are enabled on boot:

```bash
systemctl is-enabled caddy
systemctl is-enabled tuwunel
```

---

## 8. Configure DNS (Vercel)

In Vercel, add a DNS record for the domain:

| Type | Name     | Value              |
| ---- | -------- | ------------------ |
| A    | `matrix` | `<HETZNER_VPS_IP>` |

This makes `matrix.soundadvice.club` resolve to your VPS. Caddy automatically obtains a TLS certificate for this domain.

Verify DNS resolution:

```bash
dig matrix.soundadvice.club
```

---

## 9. Matrix Delegation (.well-known)

Matrix uses `.well-known` files to delegate server discovery. This allows Matrix IDs to be `@user:soundadvice.club` while the actual homeserver runs at `matrix.soundadvice.club`.

These files are served from the **landing page project** deployed on Vercel (separate repository).

### Create the delegation files

In the landing project, create two files under `public/`:

**`public/.well-known/matrix/server`**

```json
{
  "m.server": "matrix.soundadvice.club:443"
}
```

**`public/.well-known/matrix/client`**

```json
{
  "m.homeserver": {
    "base_url": "https://matrix.soundadvice.club"
  },
  "m.identity_server": {
    "base_url": "https://vector.im"
  }
}
```

### Configure response headers

In the landing project's `vercel.json`, add headers so Matrix clients can read these files correctly:

```json
{
  "headers": [
    {
      "source": "/.well-known/matrix/:path*",
      "headers": [
        {
          "key": "Content-Type",
          "value": "application/json"
        },
        {
          "key": "Access-Control-Allow-Origin",
          "value": "*"
        }
      ]
    }
  ]
}
```

### Verify delegation

After deploying, verify the files are served correctly:

```bash
curl -L https://soundadvice.club/.well-known/matrix/server
# Expected: {"m.server": "matrix.soundadvice.club:443"}

curl -L https://soundadvice.club/.well-known/matrix/client
# Expected: {"m.homeserver": {"base_url": "https://matrix.soundadvice.club"}, ...}
```

> [!NOTE]
> Vercel may return a redirect (e.g. to `www.soundadvice.club`) before serving the file. This is normal -- Matrix clients follow redirects automatically. Use `curl -L` to verify.

---

## 10. Final Verification

1. Check that Caddy and Tuwunel are running:

```bash
systemctl status caddy --no-pager -l
systemctl status tuwunel --no-pager -l
```

2. Check that the Matrix homeserver responds:

```bash
curl https://matrix.soundadvice.club/_matrix/client/versions
```

3. Check that `.well-known` delegation works:

```bash
curl -L https://soundadvice.club/.well-known/matrix/server
curl -L https://soundadvice.club/.well-known/matrix/client
```

4. Test SSO login by opening in a browser:

```
https://matrix.soundadvice.club/_matrix/client/v3/login/sso/redirect?provider=<SUPABASE_OAUTH_CLIENT_ID>&redirectUrl=https://connect.soundadvice.club
```
